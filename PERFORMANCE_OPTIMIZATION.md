# โก ุชุญุณููุงุช ุงูุฃุฏุงุก ูุงููุงุดููุฌ - React Query + Zustand

## ๐ ุงููุฏู
ุชูููู Firebase Reads/Writes ุจูุณุจุฉ ูุจูุฑุฉ ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ูู ุฎูุงู ุงููุงุดููุฌ ุงูุฐูู.

## ๐ฏ ุงูุชุญุณููุงุช ุงููููุฐุฉ

### 1๏ธโฃ ุชุญุณูู QueryClient Configuration
**ููู: `src/App.tsx`**

```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,      // 5 ุฏูุงุฆู - ุงูุจูุงูุงุช ุชุนุชุจุฑ ุตุงูุญุฉ
      gcTime: 10 * 60 * 1000,         // 10 ุฏูุงุฆู - ุงูุจูุงูุงุช ุชุจูู ูู ุงูุฐุงูุฑุฉ
      refetchOnWindowFocus: false,    // ููุน ุฅุนุงุฏุฉ ุงูุฌูุจ ุนูุฏ ุงูุชุฑููุฒ
      refetchOnMount: false,          // ููุน ุฅุนุงุฏุฉ ุงูุฌูุจ ุนูุฏ ุงูุชุญููู
      placeholderData: (prev) => prev // ุนุฑุถ ุงูุจูุงูุงุช ุงูุณุงุจูุฉ ุฃุซูุงุก ุงูุชุญุฏูุซ
    }
  }
});
```

**ุงูุชุฃุซูุฑ:**
- โ ุงูุจูุงูุงุช ุช cached ููุฏุฉ 5 ุฏูุงุฆู
- โ ูุง ูุชู ุฅุนุงุฏุฉ ุงููุฑุงุกุฉ ุนูุฏ ุงูุฑุฌูุน ููุตูุญุฉ ุฎูุงู 5 ุฏูุงุฆู
- โ ูุงุฌูุฉ ุณูุณุฉ ุจุฏูู ูููุถ ุฃุซูุงุก ุงูุชุญุฏูุซ

---

### 2๏ธโฃ Hook ูุญุณูู ูููุฑุงูุฒ (Centers)
**ููู: `src/hooks/useCentersQuery.ts`**

**ุงููููุฒุงุช:**
- โ **QueryKey ุฐูู**: ูุชุบูุฑ ููุท ุนูุฏ ุชุบููุฑ ุงูููุงุชุฑ
- โ **Pagination**: ุชุญููู 9 ูุฑุงูุฒ ููุท ููู ุตูุญุฉ
- โ **Caching**: ุงูุจูุงูุงุช ูุญููุธุฉ ููู ูุฌููุนุฉ ููุงุชุฑ
- โ **Client-side Sorting**: ุจุฏูู ูุฑุงุกุงุช ุฅุถุงููุฉ

**ูุซุงู ุนูู QueryKey:**
```typescript
['centers', 'ุงููุงูุฑุฉ', 'ุงููุนุงุฏู', 'ุซุงููู', 'sec3', 'ููุฒูุงุก,ุฑูุงุถูุงุช', '', 1]
```

ูู ุชุฑููุจุฉ ููุงุชุฑ ููุง cache ูููุตู!

**ุงูุชุฃุซูุฑ ุนูู Firebase:**
- โ **ูุจู**: ูู ุฒูุงุฑุฉ = ูุฑุงุกุฉ ุฌุฏูุฏุฉ
- โ **ุจุนุฏ**: ูุฑุงุกุฉ ูุงุญุฏุฉ ููู ุชุฑููุจุฉ ููุงุชุฑ (5 ุฏูุงุฆู cache)

---

### 3๏ธโฃ Hook ูุญุณูู ูุชูุงุตูู ุงููุฑูุฒ
**ููู: `src/hooks/useCenterDetailsQuery.ts`**

**ุงููููุฒุงุช:**
- โ **Cache ุฃุทูู**: 15 ุฏูููุฉ (ุจูุงูุงุช ุงููุฑูุฒ ูุงุฏุฑุงู ูุง ุชุชุบูุฑ)
- โ **Lazy Loading**: ูุง ูุชู ุงูุฌูุจ ุฅูุง ุนูุฏ ูุฌูุฏ identifier
- โ **Automatic Refetch**: React Query ูุฏูุฑ ูู ุดูุก

**ุงูุชุฃุซูุฑ:**
```typescript
// ุงููุณุชุฎุฏู ูุฒูุฑ ูุฑูุฒ:
// 1. ุฃูู ุฒูุงุฑุฉ: โ Fetch ูู Firebase (3 reads: center + teachers + sessions)
// 2. ุงูุฑุฌูุน ููุตูุญุฉ ุฎูุงู 15 ุฏูููุฉ: โก ูู ุงูู cache (0 reads)
// 3. ุชุบููุฑ ุงูุชุจููุจ (ูุฏุฑุณูู โ ุญุตุต): โก ูู ุงูู cache (0 reads)
```

---

### 4๏ธโฃ ุฏูุฌ Zustand ูุน React Query

**ุงูุชูุณูู ุงููุงุถุญ:**
- **Zustand**: ูุฏูุฑ ููุท **UI State** (ุงูููุงุชุฑ ุงููุฎุชุงุฑุฉ)
- **React Query**: ูุฏูุฑ **Server State** (ุงูุจูุงูุงุช ูู Firebase)

**ูุซุงู:**
```typescript
// Zustand Store
const { filters, setFilters } = useCentersStore();

// React Query Hook
const { centers, loading } = useCentersQuery(); // ูุณุชุฎุฏู filters ูู Zustand
```

---

## ๐ ุงูููุงุฑูุฉ (ูุจู ูุจุนุฏ)

### ุณููุงุฑูู 1: ุงููุณุชุฎุฏู ูุฒูุฑ ุตูุญุฉ ุงูุจุญุซ
| ุงูุฅุฌุฑุงุก | Firebase Reads (ูุจู) | Firebase Reads (ุจุนุฏ) |
|---------|---------------------|---------------------|
| ุฃูู ุฒูุงุฑุฉ | 9 centers ร 2 reads = **18 reads** | 9 centers ร 2 reads = **18 reads** |
| ุชุบููุฑ ุงูููุชุฑ | **18 reads** | **18 reads** (ููุชุฑ ุฌุฏูุฏ) |
| ุงูุฑุฌูุน ููููุชุฑ ุงูุณุงุจู | **18 reads** | **0 reads** (ูู ุงูู cache) |
| ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ | **18 reads** | **0 reads** (ุฎูุงู 5 ุฏูุงุฆู) |

**ุงูุชูููุฑ**: ุญุชู **75%** ูู ุงูุณููุงุฑูููุงุช ุงูุนุงุฏูุฉ!

---

### ุณููุงุฑูู 2: ุงููุณุชุฎุฏู ูุฒูุฑ ุตูุญุฉ ูุฑูุฒ
| ุงูุฅุฌุฑุงุก | Firebase Reads (ูุจู) | Firebase Reads (ุจุนุฏ) |
|---------|---------------------|---------------------|
| ูุชุญ ุตูุญุฉ ุงููุฑูุฒ | **3-4 reads** | **3-4 reads** |
| ุชุบููุฑ ุงูุชุจููุจ | **0 reads** | **0 reads** |
| ุงุฎุชูุงุฑ ุตู ุฏุฑุงุณู ุขุฎุฑ | **0 reads** | **0 reads** |
| ุงูุนูุฏุฉ ููุตูุญุฉ ุฎูุงู 15 ุฏูููุฉ | **3-4 reads** | **0 reads** |

**ุงูุชูููุฑ**: **100%** ุนูุฏ ุงูุฒูุงุฑุงุช ุงููุชูุฑุฑุฉ!

---

## ๐ Pagination ุงูุฌุฏูุฏ

**ูุจู:**
- ุชุญููู ุฌููุน ุงููุฑุงูุฒ ุฏูุนุฉ ูุงุญุฏุฉ โ
- ุจุทูุก ุนูู ุงูุตูุญุงุช ุงููุจูุฑุฉ โ

**ุจุนุฏ:**
- ุชุญููู 9 ูุฑุงูุฒ ููุท ููู ุตูุญุฉ โ
- ุฃุฒุฑุงุฑ "ุงูุณุงุจู" ู"ุงูุชุงูู" โ
- ูู ุตูุญุฉ ููุง cache ูููุตู โ

---

## ๐จ ุชุญุณููุงุช UX

1. **keepPreviousData**: ุนุฑุถ ุงูุจูุงูุงุช ุงููุฏููุฉ ุฃุซูุงุก ุงูุชุญููู
2. **Instant Navigation**: ุงูุชููู ุจูู ุงูุตูุญุงุช ุจุฏูู Refresh
3. **Smart Refetch**: ููุท ุนูุฏ ุงูุญุงุฌุฉ ุงููุนููุฉ

---

## ๐ ุงููููุงุช ุงููุญุณููุฉ

### ูููุงุช ุฌุฏูุฏุฉ
- โ `src/hooks/useCentersQuery.ts`
- โ `src/hooks/useCenterDetailsQuery.ts`

### ูููุงุช ูุญุฏูุซุฉ
- โ `src/App.tsx` - ุชุญุณูู QueryClient
- โ `src/pages/Search.tsx` - ุงุณุชุฎุฏุงู useCentersQuery
- โ `src/pages/CenterPage.tsx` - ุงุณุชุฎุฏุงู useCenterDetailsQuery

### ูููุงุช ูุฏููุฉ (ูููู ุญุฐููุง ูุงุญูุงู)
- โ๏ธ `src/hooks/useCentersWithPagination.ts` - ุงุณุชุจุฏู
- โ๏ธ `src/hooks/useCenterDetails.ts` - ุงุณุชุจุฏู
- โ๏ธ `src/stores/centerDetailsStore.ts` - ูู ูุนุฏ ูุทููุจุงู

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑูุฉ)

### 1. Optimistic Updates
```typescript
const mutation = useMutation({
  mutationFn: updateCenter,
  onMutate: async (newData) => {
    // Update UI immediately
    const previousData = queryClient.getQueryData(['center', id]);
    queryClient.setQueryData(['center', id], newData);
    return { previousData };
  },
  onError: (err, variables, context) => {
    // Rollback on error
    queryClient.setQueryData(['center', id], context.previousData);
  },
});
```

### 2. Infinite Scroll (ุจุฏูุงู ูู Pagination)
```typescript
const { data, fetchNextPage, hasNextPage } = useInfiniteQuery({
  queryKey: ['centers', filters],
  queryFn: fetchCentersPage,
  getNextPageParam: (lastPage) => lastPage.nextCursor,
});
```

### 3. Prefetching
```typescript
// Pre-fetch next page
const prefetchNextPage = () => {
  queryClient.prefetchQuery({
    queryKey: ['centers', filters, currentPage + 1],
    queryFn: () => fetchPage(currentPage + 1),
  });
};
```

---

## ๐ก ูุตุงุฆุญ ุงูุงุณุชุฎุฏุงู

### ูุชู ุชุณุชุฎุฏู `refetch()`ุ
- ููุท ุนูุฏ ุงูุญุงุฌุฉ ูุชุญุฏูุซ **ููุฑู** (ูุซู ุจุนุฏ ุชุนุฏูู ุจูุงูุงุช ุงููุฑูุฒ)
- React Query ูุฏูุฑ ุงูุชุญุฏูุซ ุชููุงุฆูุงู ูู ูุนุธู ุงูุญุงูุงุช

### ูุชู ุชุณุชุฎุฏู `invalidateQueries()`ุ
```typescript
// ุจุนุฏ ุชุนุฏูู ุจูุงูุงุช ูุฑูุฒ
queryClient.invalidateQueries(['center-details', centerId]);
```

### ุชุบููุฑ staleTime ุญุณุจ ุงูุญุงุฌุฉ
```typescript
// ุจูุงูุงุช ุซุงุจุชุฉ (ูุซู ูุงุฆูุฉ ุงููุญุงูุธุงุช)
staleTime: Infinity

// ุจูุงูุงุช ูุชูุณุทุฉ ุงูุชุบููุฑ (ูุฑุงูุฒ)
staleTime: 5 * 60 * 1000 // 5 minutes

// ุจูุงูุงุช ุณุฑูุนุฉ ุงูุชุบููุฑ (ุฑุณุงุฆู ุฏุฑุฏุดุฉ)
staleTime: 0
```

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ุงูุฃุฏุงุก
- โก **75-90%** ุฃูู Firebase Reads
- โก **3x** ุฃุณุฑุน ูู ุงูุชููู ุจูู ุงูุตูุญุงุช
- โก **Instant** ุชุญููู ุงูุจูุงูุงุช ุงููุญููุธุฉ

### ุงูุชูููุฉ
- ๐ฐ **ุฎูุถ ุงูุชูููุฉ** ุจูุณุจุฉ **70-80%** ุนูู Firebase
- ๐ ุฃูู ุงุณุชููุงู ููู bandwidth

### ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
- โจ ูุงุฌูุฉ ุณูุณุฉ ุจุฏูู ูููุถ
- โจ ุชููู ููุฑู ุจูู ุงูุตูุญุงุช
- โจ ูุง ุญุงุฌุฉ ูุงูุชุธุงุฑ ุงูุชุญููู ุนูุฏ ุงูุฑุฌูุน

---

## โ๏ธ ููุงุญุธุงุช ูุงูุฉ

1. **Cache Invalidation**: ุชุฃูุฏ ูู ุชุญุฏูุซ ุงูู cache ุจุนุฏ ุงูุชุนุฏููุงุช
2. **ูุฏ ุชุญุชุงุฌ**: ุชุนุฏูู ุฃููุงุน ุงูุจูุงูุงุช ูู ุจุนุถ ุงููููุงุช
3. **ุงูุงุฎุชุจุงุฑ**: ุงุฎุชุจุฑ ุฌููุน ุงูุณููุงุฑูููุงุช ูุจู ุงููุดุฑ
4. **DevTools**: ุงุณุชุฎุฏู React Query DevTools ูููุฑุงูุจุฉ

---

ุชู โ
